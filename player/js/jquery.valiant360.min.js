/*! jquery.valiant360 - v0.4.3 - 2016-10-11
 * http://flimshaw.github.io/Valiant360
 * Copyright (c) 2016 Charlie Hoey <me@charliehoey.com>; Licensed MIT */

var Detector={canvas:!!window.CanvasRenderingContext2D,webgl:function(){try{var a=document.createElement("canvas");return!!window.WebGLRenderingContext&&(a.getContext("webgl")||a.getContext("experimental-webgl"))}catch(b){return!1}}(),workers:!!window.Worker,fileapi:window.File&&window.FileReader&&window.FileList&&window.Blob,getWebGLErrorMessage:function(){var a=document.createElement("div");return a.id="webgl-error-message",a.style.fontFamily="monospace",a.style.fontSize="13px",a.style.fontWeight="normal",a.style.textAlign="center",a.style.background="#fff",a.style.color="#000",a.style.padding="1.5em",a.style.width="400px",a.style.margin="5em auto 0",this.webgl||(a.innerHTML=window.WebGLRenderingContext?['Your graphics card does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br />','Find out how to get it <a href="http://get.webgl.org/" style="color:#000">here</a>.'].join("\n"):['Your browser does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br/>','Find out how to get it <a href="http://get.webgl.org/" style="color:#000">here</a>.'].join("\n")),a},addGetWebGLMessage:function(a){var b,c,d;a=a||{},b=void 0!==a.parent?a.parent:document.body,c=void 0!==a.id?a.id:"oldie",d=Detector.getWebGLErrorMessage(),d.id=c,b.appendChild(d)}};!function(a,b,c,d,e,f){function g(b,c){this.element=b,this.options=a.extend({},i,c),this._defaults=i,this._name=h,this.init()}var h="Valiant360",i={crossOrigin:"anonymous",clickAndDrag:!1,keyboardControls:!0,fov:35,fovMin:3,fovMax:100,hideControls:!1,lon:0,lat:0,loop:"loop",muted:!0,volume:.5,debug:!1,flatProjection:!1,autoplay:!0};g.prototype={init:function(){this._time=(new Date).getTime(),this._controls={},this._id=this.generateUUID(),this._requestAnimationId="",this._isVideo=!1,this._isPhoto=!1,this._isFullscreen=!1,this._mouseDown=!1,this._dragStart={},this._lat=this.options.lat,this._lon=this.options.lon,this._fov=this.options.fov,this._originalWidth=a(this.element).find("canvas").width(),this._originalHeight=a(this.element).find("canvas").height(),a(this.element).addClass("Valiant360_default"),this.options.keyboardControls&&!a(this.element).attr("tabindex")&&a(this.element).attr("tabindex","1"),this.createMediaPlayer(),this.createControls()},generateUUID:function(){var a=(new Date).getTime(),b="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(b){var c=(a+16*Math.random())%16|0;return a=Math.floor(a/16),("x"===b?c:7&c|8).toString(16)});return b},createMediaPlayer:function(){var g=this;this._scene=new b.Scene,this._camera=new b.PerspectiveCamera(this._fov,a(this.element).width()/a(this.element).height(),.1,1e3),this._camera.setLens(this._fov),this._renderer=c.webgl?new b.WebGLRenderer:new b.CanvasRenderer,this._renderer.setSize(a(this.element).width(),a(this.element).height()),this._renderer.autoClear=!1,this._renderer.setClearColor(3355443,1),a(this.element).append(this._renderer.domElement);var h=function(){g._texture.generateMipmaps=!1,g._texture.minFilter=b.LinearFilter,g._texture.magFilter=b.LinearFilter,g._texture.format=b.RGBFormat,g._mesh=new b.Mesh(new b.SphereGeometry(500,80,50),new b.MeshBasicMaterial({map:g._texture})),g._mesh.scale.x=-1,g._scene.add(g._mesh),g.animate()};if(a(this.element).attr("data-photo-src"))this._isPhoto=!0,b.ImageUtils.crossOrigin=this.options.crossOrigin,this._texture=b.ImageUtils.loadTexture(a(this.element).attr("data-photo-src")),h();else{this._isVideo=!0;var i='<div class="loading"> 										<div class="icon waiting-icon"></div> 										<div class="icon error-icon"><i class="fa fa-exclamation-triangle" aria-hidden="true"></i></div> 									</div>';a(this.element).append(i),this.showWaiting(),this._video=e.createElement("video"),this._video.setAttribute("crossorigin",this.options.crossOrigin),this._video.style.display="none",a(this.element).append(this._video),this._video.loop=this.options.loop,this._video.muted=this.options.muted,this._video.volume=this.options.volume,this._video.addEventListener("ended",function(){}),this._video.addEventListener("progress",function(){var a=null;g._video&&g._video.buffered&&g._video.buffered.length>0&&g._video.buffered.end&&g._video.duration?a=g._video.buffered.end(0)/g._video.duration:g._video&&g._video.bytesTotal!==f&&g._video.bytesTotal>0&&g._video.bufferedBytes!==f&&(a=g._video.bufferedBytes/g._video.bytesTotal);Math.round(100*a)}),this._video.addEventListener("error",function(a){console.error(g._video.error),g.showError()}),this._video.addEventListener("timeupdate",function(){if(this.paused===!1){var b=100*this.currentTime/this.duration;a(g.element).find(".controlsWrapper > .valiant-progress-bar")[0].children[0].setAttribute("style","width:"+b+"%;"),a(g.element).find(".controlsWrapper > .valiant-progress-bar")[0].children[1].setAttribute("style","width:"+(100-b)+"%;");var c=Math.floor(this.duration/60),d=Math.floor(this.duration-60*c),e=Math.floor(this.currentTime/60),f=Math.floor(this.currentTime-60*e),h=c+":"+(10>d?"0"+d:d),i=e+":"+(10>f?"0"+f:f);a(g.element).find(".controls .timeLabel").html(i+" / "+h)}});var j="Microsoft Internet Explorer"==navigator.appName||!(!navigator.userAgent.match(/Trident/)&&!navigator.userAgent.match(/rv 11/));j?(this._videocanvas=e.createElement("canvas"),this._texture=new b.Texture(this._videocanvas),this._video.addEventListener("loadedmetadata",function(){g._videocanvas.width=g._video.videoWidth,g._videocanvas.height=g._video.videoHeight,h()})):this._texture=new b.Texture(this._video);var k=new XMLHttpRequest;k.open("GET",a(this.element).attr("data-video-src"),!0),k.responseType="blob",k.onload=function(b){if(200===this.status){var c=(d.webkitURL?webkitURL:URL).createObjectURL(this.response);a(g._video).bind("canplaythrough",function(){g.options.autoplay===!0&&(g.hideWaiting(),g.play(),g._videoReady=!0)}),g._video.src=c}},k.onreadystatechange=function(a){4===k.readyState&&200!==k.status&&(console.error("Video error: status "+k.status),g.showError())},k.send(),j||h()}},createControls:function(){var b=this.options.muted?"fa-volume-off":"fa-volume-up",c=this.options.autoplay?"fa-pause":"fa-play",d='               <div class="controlsWrapper">                <div class="valiant-progress-bar">                    <div style="width: 0;"></div><div style="width: 100%;"></div>                </div>                <div class="controls">                     <a href="#" class="playButton button fa '+c+'"></a> 					<div class="audioControl">						<a href="#" class="muteButton button fa '+b+'"></a> 						<div class="volumeControl">							<div class="volumeBar">								<div class="volumeProgress"></div>								<div class="volumeCursor"></div>							</div>						</div>					</div>					<span class="timeLabel"></span>                     <a href="#" class="fullscreenButton button fa fa-expand"></a>                 </div>               </div>            ';a(this.element).append(d,!0),a(this.element).append('<div class="timeTooltip">00:00</div>',!0),this.options.hideControls&&a(this.element).find(".controls").hide(),this.attachControlEvents()},attachControlEvents:function(){var b=this;this.element.addEventListener("mousemove",this.onMouseMove.bind(this),!1),this.element.addEventListener("touchmove",this.onMouseMove.bind(this),!1),this.element.addEventListener("mousewheel",this.onMouseWheel.bind(this),!1),this.element.addEventListener("DOMMouseScroll",this.onMouseWheel.bind(this),!1),this.element.addEventListener("mousedown",this.onMouseDown.bind(this),!1),this.element.addEventListener("touchstart",this.onMouseDown.bind(this),!1),this.element.addEventListener("mouseup",this.onMouseUp.bind(this),!1),this.element.addEventListener("touchend",this.onMouseUp.bind(this),!1),this.options.keyboardControls&&(this.element.addEventListener("keydown",this.onKeyDown.bind(this),!1),this.element.addEventListener("keyup",this.onKeyUp.bind(this),!1),this.element.addEventListener("keyArrowPress",this.onKeyArrowPress.bind(this),!1),this.element.addEventListener("click",function(){a(b.element).focus()},!1)),a(b.element).find(".controlsWrapper > .valiant-progress-bar")[0].addEventListener("click",this.onProgressClick.bind(this),!1),a(b.element).find(".controlsWrapper > .valiant-progress-bar")[0].addEventListener("mousemove",this.onProgressMouseMove.bind(this),!1),a(b.element).find(".controlsWrapper > .valiant-progress-bar")[0].addEventListener("mouseout",this.onProgressMouseOut.bind(this),!1),a(e).on("webkitfullscreenchange mozfullscreenchange fullscreenchange MSFullscreenChange",this.fullscreen.bind(this)),a(d).resize(function(){b.resizeGL(a(b.element).width(),a(b.element).height())}),a(this.element).find(".playButton").click(function(c){c.preventDefault(),a(this).hasClass("fa-pause")?(a(this).removeClass("fa-pause").addClass("fa-play"),b.pause()):(a(this).removeClass("fa-play").addClass("fa-pause"),b.play())}),a(this.element).find(".fullscreenButton").click(function(c){c.preventDefault();var d=a(b.element)[0];a(this).hasClass("fa-expand")?d.requestFullscreen?d.requestFullscreen():d.msRequestFullscreen?d.msRequestFullscreen():d.mozRequestFullScreen?d.mozRequestFullScreen():d.webkitRequestFullscreen&&d.webkitRequestFullscreen():d.requestFullscreen?e.exitFullscreen():d.msRequestFullscreen?e.msExitFullscreen():d.mozRequestFullScreen?e.mozCancelFullScreen():d.webkitRequestFullscreen&&e.webkitExitFullscreen()}),a(this.element).find(".muteButton").click(function(c){c.preventDefault(),a(this).hasClass("fa-volume-off")?(a(this).removeClass("fa-volume-off").addClass("fa-volume-up"),b._video.muted=!1):(a(this).removeClass("fa-volume-up").addClass("fa-volume-off"),b._video.muted=!0)}),a(this.element).find(".controlsWrapper .volumeControl").mousedown(this.onVolumeMouseDown.bind(this)).mouseup(this.onVolumeMouseUp.bind(this)).mouseleave(this.onVolumeMouseUp.bind(this)).mousemove(this.onVolumeMouseMove.bind(this)),a(this._video).on("volumechange",this.onVolumeChange.bind(this))},onMouseMove:function(b){this._onPointerDownPointerX=b.clientX,this._onPointerDownPointerY=-b.clientY,this.relativeX=b.pageX-a(this.element).find("canvas").offset().left,this._onPointerDownLon=this._lon,this._onPointerDownLat=this._lat;var c,d;this.options.clickAndDrag?this._mouseDown&&(c=b.pageX-this._dragStart.x,d=b.pageY-this._dragStart.y,this._dragStart.x=b.pageX,this._dragStart.y=b.pageY,this._lon+=c,this._lat-=d):(c=b.pageX-a(this.element).find("canvas").offset().left,d=b.pageY-a(this.element).find("canvas").offset().top,this._lon=c/a(this.element).find("canvas").width()*430-225,this._lat=d/a(this.element).find("canvas").height()*-180+90)},onMouseWheel:function(a){var b=-.01;a.wheelDeltaY?this._fov-=a.wheelDeltaY*b:a.wheelDelta?this._fov-=a.wheelDelta*b:a.detail&&(this._fov+=1*a.detail),this._fov<this.options.fovMin?this._fov=this.options.fovMin:this._fov>this.options.fovMax&&(this._fov=this.options.fovMax),this._camera.setLens(this._fov),a.preventDefault()},onMouseDown:function(a){this._mouseDown=!0,this._dragStart.x=a.pageX,this._dragStart.y=a.pageY},onProgressClick:function(b){if(this._isVideo&&this._video.readyState===this._video.HAVE_ENOUGH_DATA){var c=this.relativeX/a(this.element).find("canvas").width()*100;a(this.element).find(".controlsWrapper > .valiant-progress-bar")[0].children[0].setAttribute("style","width:"+c+"%;"),a(this.element).find(".controlsWrapper > .valiant-progress-bar")[0].children[1].setAttribute("style","width:"+(100-c)+"%;"),this._video.currentTime=this._video.duration*c/100}},onProgressMouseMove:function(b){var c=this.relativeX/a(this.element).find("canvas").width()*100;if(c){var d=a(this.element).find(".timeTooltip"),e=this.relativeX-d.width()/2;e=0>e?0:Math.min(e,a(this.element).find("canvas").width()-d.outerWidth()),d.css({left:e+"px"}),d.show();var f=c/100*this._video.duration,g=Math.floor(f/60),h=Math.floor(f-60*g);d.html(g+":"+(10>h?"0"+h:h))}},onProgressMouseOut:function(b){a(this.element).find(".timeTooltip").hide()},onMouseUp:function(a){this._mouseDown=!1},onKeyDown:function(a){var b=a.keyCode;if(b>=37&&40>=b){a.preventDefault(),this._keydown=!0;var c=e.createEvent("CustomEvent");c.initCustomEvent("keyArrowPress",!0,!0,{keyCode:b}),this.element.dispatchEvent(c)}},onKeyUp:function(a){var b=a.keyCode;b>=37&&40>=b&&(a.preventDefault(),this._keydown=!1)},onKeyArrowPress:function(a){if(this._keydown){var b=a.detail?a.detail.keyCode:null,c=3,d=50,f=this.element;switch(a.preventDefault(),b){case 37:this._lon-=c;break;case 39:this._lon+=c;break;case 38:this._lat+=c;break;case 40:this._lat-=c}setTimeout(function(){var a=e.createEvent("CustomEvent");a.initCustomEvent("keyArrowPress",!0,!0,{keyCode:b}),f.dispatchEvent(a)},d)}},onVolumeMouseDown:function(a){a.preventDefault(),this._volumeMouseDown=!0,this.onVolumeMouseMove(a)},onVolumeMouseUp:function(a){a.preventDefault(),this._volumeMouseDown=!1},onVolumeMouseMove:function(b){if(b.preventDefault(),this._volumeMouseDown){var c=a(this.element).find(".controlsWrapper .volumeControl"),d=(this.relativeX-c.offset().left+c.find(".volumeBar > .volumeCursor").width()/2)/c.width()*100;d>=0&&100>=d&&(this._video.volume=d/100)}},onVolumeChange:function(b){var c=1!=this._video.muted||this._volumeMouseDown?100*this._video.volume:0;a(this.element).find(".controlsWrapper .volumeControl > .volumeBar").css({width:c+"%"});var d=a(this.element).find(".muteButton");(c>0&&d.hasClass("fa-volume-off")||0==c&&d.hasClass("fa-volume-up"))&&d.click()},animate:function(){if(this._requestAnimationId=requestAnimationFrame(this.animate.bind(this)),this._isVideo&&this._video.readyState===this._video.HAVE_ENOUGH_DATA&&(this._videocanvas&&this._videocanvas.getContext("2d").drawImage(this._video,0,0,this._videocanvas.width,this._videocanvas.height),"undefined"!=typeof this._texture)){var a=(new Date).getTime();a-this._time>=30&&(this._texture.needsUpdate=!0,this._time=a)}this.render()},render:function(){this._lat=Math.max(-85,Math.min(85,this._lat)),this._phi=(90-this._lat)*Math.PI/180,this._theta=this._lon*Math.PI/180;var a=500*Math.sin(this._phi)*Math.cos(this._theta),c=500*Math.cos(this._phi),d=500*Math.sin(this._phi)*Math.sin(this._theta);this._camera.lookAt(new b.Vector3(a,c,d)),this.options.flatProjection?(this._camera.position.x=0,this._camera.position.y=0,this._camera.position.z=0):(this._camera.position.x=-a,this._camera.position.y=-c,this._camera.position.z=-d),this._renderer.clear(),this._renderer.render(this._scene,this._camera)},play:function(){this._video.play()},pause:function(){this._video.pause()},loadVideo:function(a){this._video.src=a},unloadVideo:function(){this.pause(),this._video.src="",this._video.removeAttribute("src")},loadPhoto:function(a){this._texture=b.ImageUtils.loadTexture(a)},fullscreen:function(){a(this.element).find("a.fa-expand").length>0?(this.resizeGL(screen.width,screen.height),a(this.element).addClass("fullscreen"),a(this.element).find("a.fa-expand").removeClass("fa-expand").addClass("fa-compress"),this._isFullscreen=!0):(this.resizeGL(this._originalWidth,this._originalHeight),a(this.element).removeClass("fullscreen"),a(this.element).find("a.fa-compress").removeClass("fa-compress").addClass("fa-expand"),this._isFullscreen=!1)},resizeGL:function(a,b){this._renderer.setSize(a,b),this._camera.aspect=a/b,this._camera.updateProjectionMatrix()},showWaiting:function(){var b=a(this.element).find(".loading");b.find(".waiting-icon").show(),b.find(".error-icon").hide(),b.show()},hideWaiting:function(){a(this.element).find(".loading").hide()},showError:function(){var b=a(this.element).find(".loading");b.find(".waiting-icon").hide(),b.find(".error-icon").show(),b.show()},destroy:function(){d.cancelAnimationFrame(this._requestAnimationId),this._requestAnimationId="",this._texture.dispose(),this._scene.remove(this._mesh),this._isVideo&&this.unloadVideo(),a(this._renderer.domElement).remove()}},a.fn[h]=function(b){var c=arguments;return this.each(function(){if("object"!=typeof b&&b){if(this.plugin[b])return this.plugin[b].apply(this.plugin,Array.prototype.slice.call(c,1))}else this.plugin=new g(this,b),a.data(this,"plugin_"+h)||a.data(this,"plugin_"+h,this.plugin)})}}(jQuery,THREE,Detector,window,document);